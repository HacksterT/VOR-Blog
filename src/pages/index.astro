---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro';
import SectionHeading from '../components/SectionHeading.astro';
import PostCard from '../components/PostCard.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const sorted = allPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const blogPosts = sorted.filter(p => !p.data.tags.some(t => t.toLowerCase() === 'music')).slice(0, 6);
const musicPosts = sorted.filter(p => p.data.tags.some(t => t.toLowerCase() === 'music')).slice(0, 6);

// Collect tags with counts for "Browse by topic"
const tagCounts = new Map<string, number>();
allPosts.forEach((post) => {
  post.data.tags.forEach((tag) => {
    const lower = tag.toLowerCase();
    tagCounts.set(lower, (tagCounts.get(lower) || 0) + 1);
  });
});
const topTags = [...tagCounts.entries()]
  .sort((a, b) => b[1] - a[1])
  .slice(0, 8);
---

<BaseLayout>
  <Hero />

  <!-- Recent Posts Carousel -->
  {blogPosts.length > 0 && (
    <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-20">
      <SectionHeading
        title="Recent Posts"
        subtitle="Reflections on faith, repentance, and spiritual growth."
        linkHref="/blog"
      />
      <div class="flex items-center justify-center gap-6 mb-6">
        <button
          id="blog-prev"
          style="color: #A8863E; font-size: 2rem; background: none; border: none; cursor: pointer; line-height: 1;"
          aria-label="Previous posts"
        >&#9664;</button>
        <p id="blog-counter" class="text-sm font-heading text-vor-muted">
          1 of 1
        </p>
        <button
          id="blog-next"
          style="color: #A8863E; font-size: 2rem; background: none; border: none; cursor: pointer; line-height: 1;"
          aria-label="Next posts"
        >&#9654;</button>
      </div>
      <div id="blog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {blogPosts.map((post, i) => (
          <div class="carousel-card-blog" data-index={i}>
            <PostCard
              title={post.data.title}
              date={post.data.date}
              description={post.data.description}
              slug={post.id}
              tags={post.data.tags}
              coverImage={post.data.coverImage}
            />
          </div>
        ))}
      </div>
    </section>
  )}

  <!-- Music Carousel -->
  {musicPosts.length > 0 && (
    <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-16 md:pb-20">
      <SectionHeading
        title="Music"
        subtitle="Original songs born from faith, reflection, and worship."
        linkHref="/music"
      />
      <div class="flex items-center justify-center gap-6 mb-6">
        <button
          id="music-prev"
          style="color: #A8863E; font-size: 2rem; background: none; border: none; cursor: pointer; line-height: 1;"
          aria-label="Previous music"
        >&#9664;</button>
        <p id="music-counter" class="text-sm font-heading text-vor-muted">
          1 of 1
        </p>
        <button
          id="music-next"
          style="color: #A8863E; font-size: 2rem; background: none; border: none; cursor: pointer; line-height: 1;"
          aria-label="Next music"
        >&#9654;</button>
      </div>
      <div id="music-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {musicPosts.map((post, i) => (
          <div class="carousel-card-music" data-index={i}>
            <PostCard
              title={post.data.title}
              date={post.data.date}
              description={post.data.description}
              slug={post.id}
              tags={post.data.tags}
              coverImage={post.data.coverImage}
            />
          </div>
        ))}
      </div>
    </section>
  )}

  <!-- Browse by Topic -->
  {topTags.length > 0 && (
    <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-16 md:pb-20">
      <h3 class="text-lg font-heading font-semibold text-vor-charcoal mb-4">Browse by Topic</h3>
      <div class="flex flex-wrap gap-2">
        {topTags.map(([tag, count]) => (
          <a
            href={`/blog/tags/${tag}`}
            class="text-sm font-heading px-4 py-2 rounded-full bg-white border border-vor-sand text-vor-charcoal-light hover:bg-vor-warm no-underline transition-colors"
          >
            {tag} ({count})
          </a>
        ))}
      </div>
    </section>
  )}

  <!-- My Story Teaser -->
  <section class="bg-white border-y border-vor-sand">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-20">
      <div class="max-w-2xl mx-auto text-center">
        <h2 class="text-3xl md:text-4xl text-vor-charcoal">My Story</h2>
        <p class="mt-4 text-vor-charcoal-light text-lg leading-relaxed">
          A personal journey told chapter by chapter — the experiences, turning points,
          and moments of grace that shaped who I am today.
        </p>
        <a
          href="/story"
          class="inline-flex items-center mt-6 px-6 py-3 border border-vor-sand text-vor-charcoal font-heading font-medium text-sm rounded-lg hover:bg-vor-warm no-underline transition-colors"
        >
          Read My Story
        </a>
      </div>
    </div>
  </section>

  <!-- About Teaser -->
  <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-16 md:py-20">
    <div class="max-w-2xl mx-auto text-center">
      <h2 class="text-3xl md:text-4xl text-vor-charcoal">About Troy</h2>
      <p class="mt-4 text-vor-charcoal-light text-lg leading-relaxed">
        The voice behind Voice of Repentance — sharing insights born from a life
        of faith, reflection, and the ongoing pursuit of spiritual truth.
      </p>
      <a
        href="/about"
        class="inline-flex items-center mt-6 text-vor-gold-dark hover:text-vor-gold font-heading font-medium text-sm no-underline"
      >
        Learn more
        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </a>
    </div>
  </section>
</BaseLayout>

<script>
  function initCarousel(prefix) {
    const grid = document.getElementById(`${prefix}-grid`);
    if (!grid) return;

    const cards = grid.querySelectorAll(`.carousel-card-${prefix}`);
    const total = cards.length;
    if (total === 0) return;

    const counter = document.getElementById(`${prefix}-counter`);
    const prevBtn = document.getElementById(`${prefix}-prev`);
    const nextBtn = document.getElementById(`${prefix}-next`);
    let currentPage = 0;

    function getPerPage() {
      if (window.innerWidth >= 1024) return 3;
      if (window.innerWidth >= 768) return 2;
      return 1;
    }

    function update() {
      const perPage = getPerPage();
      const totalPages = Math.ceil(total / perPage);
      // Clamp currentPage in case resize reduced total pages
      if (currentPage >= totalPages) currentPage = totalPages - 1;

      const start = currentPage * perPage;
      const end = start + perPage;

      cards.forEach((card, i) => {
        card.style.display = (i >= start && i < end) ? '' : 'none';
      });

      counter.textContent = `${currentPage + 1} of ${totalPages}`;
    }

    prevBtn.addEventListener('click', () => {
      const totalPages = Math.ceil(total / getPerPage());
      currentPage = (currentPage - 1 + totalPages) % totalPages;
      update();
    });

    nextBtn.addEventListener('click', () => {
      const totalPages = Math.ceil(total / getPerPage());
      currentPage = (currentPage + 1) % totalPages;
      update();
    });

    window.addEventListener('resize', update);
    update();
  }

  initCarousel('blog');
  initCarousel('music');
</script>
